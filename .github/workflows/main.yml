name: Build iOS Dev Client

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      # Usiamo Xcode 16.2 come richiesto (ma potresti provare 'latest-stable' se hai ancora problemi)
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      # Installiamo expo-dev-client se non c'è
      - name: Install Expo Dev Client
        run: npx expo install expo-dev-client

      # Generiamo la cartella iOS
      - name: Prebuild
        run: npx expo prebuild --platform ios --clean

      # --- FIX 1: Aggiornamento Forzato Target iOS ---
      # Questo passaggio risolve l'errore "IPHONEOS_DEPLOYMENT_TARGET is set to 9.0"
      # e spesso risolve anche il problema degli Asset perché taglia fuori vecchie versioni incompatibili.
      - name: Fix iOS Deployment Target
        run: |
          cd ios
          # Modifica il Podfile per impostare iOS 15.1 (versione sicura e moderna)
          sed -i '' "s/platform :ios, .*/platform :ios, '15.1'/" Podfile
          # Rimuove le impostazioni post-install che potrebbero sovrascrivere la versione
          # (Opzionale ma aiuta con alcune versioni di Expo)
          echo "Fixed Podfile deployment target to 15.1"

      # Installazione Pods (ora userà la versione 15.1 settata sopra)
      - name: Install CocoaPods
        working-directory: ios
        run: pod install --repo-update

      # Trova il nome corretto dello schema (come nel fix precedente)
      - name: Find Scheme Name
        id: find_name
        run: |
          cd ios
          WORKSPACE_FILE=$(find . -maxdepth 1 -name "*.xcworkspace" | head -n 1)
          SCHEME_NAME=$(basename "$WORKSPACE_FILE" .xcworkspace)
          echo "APP_NAME=$SCHEME_NAME" >> $GITHUB_ENV

      # --- FIX 2: Build Command ---
      # Aggiunto -destination "generic/platform=iOS" per evitare che cerchi di compilare
      # gli asset per il Simulatore (che causava l'errore "No simulator runtime version").
      - name: Build iOS archive (unsigned)
        run: |
          xcodebuild \
            -workspace ios/${{ env.APP_NAME }}.xcworkspace \
            -scheme "${{ env.APP_NAME }}" \
            -configuration Debug clean archive \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            -archivePath build/${{ env.APP_NAME }}.xcarchive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            IPHONEOS_DEPLOYMENT_TARGET=15.1

      - name: Export IPA
        run: |
          mkdir -p Payload
          cp -r build/${{ env.APP_NAME }}.xcarchive/Products/Applications/*.app Payload/
          zip -r ${{ env.APP_NAME }}.ipa Payload
      
      - name: Upload .ipa
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-ipa
          path: ${{ env.APP_NAME }}.ipa
