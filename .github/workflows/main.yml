name: Build iOS Dev Client

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      # Usa l'ultima versione stabile di Xcode compatibile
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      # IMPORTANTE: Installa expo-dev-client se non è già nel package.json
      - name: Install Expo Dev Client
        run: npx expo install expo-dev-client

      # Prebuild genera le cartelle natie (ios/android)
      - name: Prebuild
        run: npx expo prebuild --platform ios --clean

      - name: Install CocoaPods
        working-directory: ios
        run: pod install

      # --- FIX: TROVA IL NOME REALE DELLO SCHEMA ---
      # Invece di leggere package.json, cerchiamo il file .xcworkspace generato
      - name: Find Scheme Name
        id: find_name
        run: |
          cd ios
          # Trova il primo file che finisce con .xcworkspace
          WORKSPACE_FILE=$(find . -maxdepth 1 -name "*.xcworkspace" | head -n 1)
          # Rimuove "./" e l'estensione ".xcworkspace" per ottenere il nome puro
          SCHEME_NAME=$(basename "$WORKSPACE_FILE" .xcworkspace)
          
          echo "Trovato workspace: $WORKSPACE_FILE"
          echo "Nome schema rilevato: $SCHEME_NAME"
          
          # Salva nelle variabili d'ambiente
          echo "APP_NAME=$SCHEME_NAME" >> $GITHUB_ENV

      # Build usando il nome corretto trovato sopra
      - name: Build iOS archive (unsigned)
        run: |
          xcodebuild \
            -workspace ios/${{ env.APP_NAME }}.xcworkspace \
            -scheme "${{ env.APP_NAME }}" \
            -configuration Debug clean archive \
            -sdk iphoneos \
            -archivePath build/${{ env.APP_NAME }}.xcarchive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY=""

      - name: Export IPA
        run: |
          # Crea la cartella Payload necessaria per l'IPA
          mkdir -p Payload
          # Copia l'app compilata dentro Payload
          cp -r build/${{ env.APP_NAME }}.xcarchive/Products/Applications/*.app Payload/
          # Zippa tutto in un file .ipa
          zip -r ${{ env.APP_NAME }}.ipa Payload
      
      - name: Upload .ipa
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-ipa
          path: ${{ env.APP_NAME }}.ipa
