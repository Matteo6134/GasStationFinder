name: Build iOS IPA (No Login Required)

on:
  workflow_dispatch:

jobs:
  build:
    name: Create IPA
    runs-on: macos-latest # Usa l'ultimo macOS (Sequoia/Sonoma nel 2026)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup Java (per Android tools se servono, altrimenti ignora)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install dependencies
        run: npm install

      # 1. GENERIAMO LE CARTELLE NATIVE (IOS/ANDROID)
      - name: Expo Prebuild
        run: npx expo prebuild --platform ios --no-interactive --clean

      # 2. FIX FORZATO DELLA VERSIONE IOS (Sostituisce 26.3 con 18.0 per non far crashare Xcode)
      - name: Fix iOS Version
        run: |
          sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = 26.3;/IPHONEOS_DEPLOYMENT_TARGET = 18.0;/g' ios/*.xcodeproj/project.pbxproj
          sed -i '' "s/platform :ios, '26.3'/platform :ios, '18.0'/g" ios/Podfile || true

      # 3. INSTALLIAMO I POD
      - name: Install Pods
        cd ios
        run: pod install --repo-update
        cd ..

      # 4. BUILD MANUALE SENZA EAS (Non richiede login)
      - name: Build xArchive
        run: |
          xcodebuild -workspace ios/GasStationFinder.xcworkspace \
            -scheme GasStationFinder \
            -configuration Release \
            -sdk iphoneos \
            -archivePath $PWD/build/GasStationFinder.xcarchive \
            archive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO

      # 5. CREAZIONE IPA
      - name: Export IPA
        run: |
          mkdir -p Payload
          mv build/GasStationFinder.xcarchive/Products/Applications/GasStationFinder.app Payload/
          zip -r GasStationFinder.ipa Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: GasStationFinder-IPA
          path: GasStationFinder.ipa
